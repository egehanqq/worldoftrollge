local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

local autoFarmEnabled = false
local grabEnabled = false
local collectDelay = 0.1
local teleportDelay = 0.1
local deleteDelay = 1
local espEnabled = false

-- blacklist
local blacklist = {
    NormalCup = false,
    BloodCup = false
}

-- ESP
local function addESP(part)
	if not part:IsA("BasePart") then return end
	if part:FindFirstChild("ESPBox") then return end

	local adorn = Instance.new("BoxHandleAdornment")
	adorn.Name = "ESPBox"
	adorn.Adornee = part
	adorn.AlwaysOnTop = true
	adorn.ZIndex = 5
	adorn.Size = part.Size + Vector3.new(0.1, 0.1, 0.1)
	adorn.Color3 = Color3.fromRGB(255, 255, 0)
	adorn.Transparency = 0.2
	adorn.Parent = part
end

local function removeESP()
	for _, obj in pairs(workspace:GetDescendants()) do
		if obj:IsA("BasePart") then
			local esp = obj:FindFirstChild("ESPBox")
			if esp then
				esp:Destroy()
			end
		end
	end
end

local function updateESP()
	if not espEnabled then
		removeESP()
		return
	end
	for _, obj in ipairs(workspace.Cups:GetChildren()) do
		local part = obj:IsA("BasePart") and obj or obj.PrimaryPart
		if part then
			addESP(part)
		end
	end
end

-- GUI
local Window = Rayfield:CreateWindow({
	Name = "Trollge Universe Incident",
	LoadingTitle = "Loading Script",
	LoadingSubtitle = "by EgehanWsa",
	ConfigurationSaving = {
		Enabled = true,
		FolderName = "TrollgeScriptConfig",
		FileName = "settings"
	},
	KeySystem = false,
})

local MainTab = Window:CreateTab("Main", 4483362458)
local BlacklistTab = Window:CreateTab("Blacklist", 4483362458)

-- Main
MainTab:CreateToggle({
	Name = "Enable AutoFarm",
	CurrentValue = false,
	Flag = "AutoFarmToggle",
	Callback = function(Value) autoFarmEnabled = Value end,
})

MainTab:CreateToggle({
	Name = "Grab Tools",
	CurrentValue = false,
	Flag = "GrabToolsToggle",
	Callback = function(Value) grabEnabled = Value end,
})

MainTab:CreateToggle({
	Name = "Enable Cup ESP",
	CurrentValue = false,
	Flag = "CupESP",
	Callback = function(Value)
		espEnabled = Value
		updateESP()
	end,
})

MainTab:CreateInput({
	Name = "Collect Delay (seconds)",
	PlaceholderText = "0.1",
	RemoveTextAfterFocusLost = false,
	Callback = function(text)
		local val = tonumber(text)
		if val and val >= 0 then collectDelay = val end
	end,
})

MainTab:CreateInput({
	Name = "Teleport Delay (seconds)",
	PlaceholderText = "0.1",
	RemoveTextAfterFocusLost = false,
	Callback = function(text)
		local val = tonumber(text)
		if val and val >= 0 then teleportDelay = val end
	end,
})

MainTab:CreateInput({
	Name = "Delete Delay (seconds)",
	PlaceholderText = "1",
	RemoveTextAfterFocusLost = false,
	Callback = function(text)
		local val = tonumber(text)
		if val and val >= 0 then deleteDelay = val end
	end,
})

-- Blacklist toggles
BlacklistTab:CreateToggle({
	Name = "Skip NormalCup",
	CurrentValue = false,
	Flag = "SkipNormalCup",
	Callback = function(Value) blacklist.NormalCup = Value end,
})

BlacklistTab:CreateToggle({
	Name = "Skip BloodCup",
	CurrentValue = false,
	Flag = "SkipBloodCup",
	Callback = function(Value) blacklist.BloodCup = Value end,
})

-- Shift toggle
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.RightShift then
		if Rayfield and Rayfield.Toggle then
			Rayfield:Toggle()
		end
	end
end)

-- ESP loop
task.spawn(function()
	while task.wait(0.5) do
		if espEnabled then updateESP() end
	end
end)

-- AutoFarm loop
task.spawn(function()
	while task.wait(0.1) do
		if autoFarmEnabled then
			local char = player.Character or player.CharacterAdded:Wait()
			local hrp = char:WaitForChild("HumanoidRootPart")

			for _, cup in ipairs(workspace.Cups:GetChildren()) do
				if not autoFarmEnabled then break end

				-- blacklist kontrol√º
				if blacklist[cup.Name] then
					continue
				end

				local part = cup:IsA("BasePart") and cup or cup:FindFirstChildWhichIsA("BasePart")
				if part then
					-- teleport
					hrp.CFrame = part.CFrame + Vector3.new(0, 3, 0)
					task.wait(teleportDelay)

					local tried = false
					for _, prompt in ipairs(cup:GetDescendants()) do
						if prompt:IsA("ProximityPrompt") and prompt.Enabled then
							pcall(function() fireproximityprompt(prompt) end)
							tried = true
							task.wait(collectDelay)
						end
					end

					-- silme
					if tried then
						task.delay(deleteDelay, function()
							if cup and cup.Parent == workspace.Cups then
								cup:Destroy()
							end
						end)
					end
				end
			end
		end

		if grabEnabled then
			for _, item in ipairs(workspace:GetDescendants()) do
				if item:IsA("Tool") and item.Parent == workspace then
					local char = player.Character or player.CharacterAdded:Wait()
					local hrp = char:WaitForChild("HumanoidRootPart")
					hrp.CFrame = item.CFrame + Vector3.new(0, 3, 0)
					task.wait(teleportDelay)
					item.Parent = player.Backpack
					task.wait(collectDelay)
				end
			end
		end
	end
end)
